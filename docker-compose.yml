name: jarvis

services:
  jarvis-agent:
    container_name: jarvis-agent
    image: nginx:alpine
    expose:
      - "80"
    networks:
      - jarvis_net
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/jarvis/data
        target: /usr/share/nginx/html
        read_only: true
        bind:
          create_host_path: true

  jarvis-brain:
    container_name: jarvis-brain
    build:
      context: /opt/jarvis/brain
      dockerfile: Dockerfile

    # ðŸ”‘ THIS IS THE CRITICAL FIX
    # Load all real values directly from /opt/jarvis/.env
    env_file:
      - /opt/jarvis/.env

    environment:
      # BarcodeBuddy
      BARCODEBUDDY_API_KEY: ${BARCODEBUDDY_API_KEY}
      BARCODEBUDDY_BASE_URL: ${BARCODEBUDDY_BASE_URL}

      # Grocy (dual household)
      GROCY_HOME_A_LOCATION_IDS: ${GROCY_HOME_A_LOCATION_IDS}
      GROCY_HOME_B_BASE_URL: ${GROCY_HOME_B_BASE_URL}
      GROCY_HOME_B_API_KEY: ${GROCY_HOME_B_API_KEY}
      GROCY_HOME_B_LOCATION_IDS: ${GROCY_HOME_B_LOCATION_IDS}

      # Home Assistant
      HOMEASSISTANT_BASE_URL: ${HOMEASSISTANT_BASE_URL}
      HOMEASSISTANT_TOKEN: ${HOMEASSISTANT_TOKEN}

      # Jarvis core
      JARVIS_API_KEY: ${JARVIS_API_KEY}
      JARVIS_DB_PATH: ${JARVIS_DB_PATH}

      # LLM
      JARVIS_LLM_PROVIDER: ${JARVIS_LLM_PROVIDER}
      JARVIS_LLM_API_KEY: ${JARVIS_LLM_API_KEY}
      JARVIS_LLM_BASE_URL: ${JARVIS_LLM_BASE_URL}
      JARVIS_LLM_MODEL: ${JARVIS_LLM_MODEL}

      # OpenAI-compatible provider support
      OPENAI_COMPATIBLE_API_BASE: ${OPENAI_COMPATIBLE_API_BASE}
      OPENAI_COMPATIBLE_API_KEY: ${OPENAI_COMPATIBLE_API_KEY}

    ports:
      - target: 8000
        published: "8000"
        protocol: tcp
        mode: ingress

    restart: unless-stopped

    volumes:
      - type: bind
        source: /opt/jarvis/brain-data
        target: /app/data
        bind:
          create_host_path: true

    networks:
      - jarvis_net

networks:
  jarvis_net:
    name: jarvis_net
    external: true
