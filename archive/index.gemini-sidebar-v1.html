<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jarvis Homelab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ========= Base ========= */

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-main: #050816;
      --bg-elevated: #0b1020;
      --bg-sidebar: #050814;
      --bg-sidebar-accent: #111827;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.2);
      --accent-gradient: linear-gradient(135deg, #4f46e5, #22c55e, #0ea5e9);
      --text-primary: #e5e7eb;
      --text-secondary: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.2);
      --radius-lg: 18px;
      --radius-xl: 24px;
      --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.7);
      --transition-fast: 150ms ease-out;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    /* ========= App Layout ========= */

    .jarvis-shell {
      width: 100%;
      max-width: 1440px;
      min-height: 100vh;
      display: flex;
      padding: 12px;
      gap: 12px;
    }

    .jarvis-sidebar {
      width: 280px;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #000 100%);
      border-radius: var(--radius-xl);
      padding: 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border: 1px solid rgba(30, 64, 175, 0.7);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      position: relative;
      overflow: hidden;
    }

    .jarvis-sidebar::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(79, 70, 229, 0.4), transparent 55%),
        radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.25), transparent 55%);
      opacity: 0.15;
      z-index: 0;
    }

    .sidebar-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 16px;
    }

    .jarvis-main {
      flex: 1;
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #000 100%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ========= Sidebar Header ========= */

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 2px 0;
    }

    .sidebar-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #22c55e 0, #4f46e5 40%, #0ea5e9 75%);
      box-shadow:
        0 0 20px rgba(59, 130, 246, 0.6),
        0 0 40px rgba(56, 189, 248, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: white;
    }

    .sidebar-title-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-title-text span:first-child {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .sidebar-title-text span:last-child {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .sidebar-new-chat-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-primary);
      font-size: 11px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast);
      white-space: nowrap;
    }

    .sidebar-new-chat-btn span.icon {
      font-size: 14px;
      margin-bottom: 1px;
    }

    .sidebar-new-chat-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 8px 18px rgba(30, 64, 175, 0.8);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
    }

    /* ========= Sidebar History ========= */

    .sidebar-section-label {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
      padding: 4px 4px;
    }

    .history-container {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 0;
      flex: 1 1 auto;
      overflow: hidden;
    }

    .history-search {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .history-search input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 12px;
      color: var(--text-primary);
    }

    .history-search input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    .history-list {
      flex: 1 1 auto;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.5) transparent;
    }

    .history-list::-webkit-scrollbar {
      width: 5px;
    }

    .history-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .history-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.5);
      border-radius: 999px;
    }

    .history-item {
      position: relative;
      padding: 8px 9px;
      border-radius: 12px;
      margin-bottom: 4px;
      cursor: pointer;
      transition:
        background var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast);
      border: 1px solid transparent;
    }

    .history-item:hover {
      background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.20), rgba(15, 23, 42, 0.98));
      border-color: rgba(79, 70, 229, 0.8);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.9);
    }

    .history-item.active {
      background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.35), rgba(15, 23, 42, 0.97));
      border-color: rgba(129, 140, 248, 0.95);
      box-shadow: 0 12px 26px rgba(30, 64, 175, 0.9);
    }

    .history-item-title {
      font-size: 12px;
      font-weight: 500;
      color: #e5e7eb;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-preview {
      font-size: 11px;
      color: var(--text-secondary);
      max-height: 30px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-meta {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: rgba(148, 163, 184, 0.9);
    }

    .history-item-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-gradient);
    }

    .history-empty {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 8px 4px 4px;
      text-align: left;
      opacity: 0.85;
    }

    .sidebar-footer {
      margin-top: 2px;
      padding-top: 6px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      font-size: 10px;
      color: rgba(148, 163, 184, 0.75);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ========= Main Header ========= */

    .main-header {
      padding: 14px 18px 10px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom,
        rgba(15, 23, 42, 0.92),
        rgba(15, 23, 42, 0.88),
        rgba(15, 23, 42, 0.75));
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .main-header-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-pill {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.08);
      border: 1px solid rgba(22, 163, 74, 0.8);
      color: rgba(187, 247, 208, 0.9);
    }

    .main-header-subtitle {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .main-header-right {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot-pulse {
      display: inline-flex;
      gap: 2px;
    }

    .dot-pulse span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.6);
      animation: pulse 1.4s infinite ease-in-out alternate;
    }

    .dot-pulse span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .dot-pulse span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes pulse {
      from {
        transform: translateY(0);
        opacity: 0.6;
      }
      to {
        transform: translateY(-2px);
        opacity: 1;
      }
    }

    /* ========= Chat Area ========= */

    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 18px 22px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scroll-behavior: smooth;
    }

    .chat-message {
      max-width: 780px;
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.6;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.94);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
      display: flex;
      gap: 10px;
    }

    .chat-message.user {
      margin-left: auto;
      background: radial-gradient(circle at top right, rgba(79, 70, 229, 0.25), rgba(15, 23, 42, 0.96));
      border-color: rgba(129, 140, 248, 0.9);
    }

    .chat-avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      margin-top: 4px;
    }

    .chat-message.bot .chat-avatar {
      background: var(--accent-gradient);
      color: #f9fafb;
      font-weight: 600;
    }

    .chat-message.user .chat-avatar {
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: rgba(148, 163, 184, 0.9);
    }

    .chat-content {
      flex: 1;
    }

    .chat-role {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, 0.85);
      margin-bottom: 4px;
    }

    .chat-text {
      white-space: pre-wrap;
      color: var(--text-primary);
    }

    .chat-empty-placeholder {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 520px;
      margin-top: 18px;
    }

    /* ========= Input Area ========= */

    .input-area-shell {
      padding: 12px 18px 18px;
      border-top: 1px solid rgba(15, 23, 42, 0.95);
      background: linear-gradient(to top,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.9));
    }

    .input-card {
      max-width: 820px;
      margin: 0 auto;
      padding: 10px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at top left,
        rgba(79, 70, 229, 0.20),
        rgba(15, 23, 42, 0.97));
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
    }

    .input-card:focus-within {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.6),
        0 18px 45px rgba(30, 64, 175, 0.95);
    }

    .input-prefix {
      font-size: 12px;
      color: rgba(156, 163, 175, 0.95);
      padding-left: 4px;
    }

    .input-field {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
    }

    .input-field::placeholder {
      color: rgba(148, 163, 184, 0.85);
    }

    .send-button {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background-image: var(--accent-gradient);
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 25px rgba(37, 99, 235, 0.8);
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        filter var(--transition-fast),
        opacity var(--transition-fast);
    }

    .send-button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      filter: grayscale(0.3);
    }

    .send-button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 35px rgba(37, 99, 235, 1);
      filter: brightness(1.05);
    }

    .send-button span.icon {
      font-size: 14px;
    }

    .input-footer {
      max-width: 820px;
      margin: 6px auto 0;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.8);
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    /* ========= Responsive ========= */

    @media (max-width: 980px) {
      .jarvis-shell {
        padding: 8px;
      }

      .jarvis-sidebar {
        display: none;
      }

      .jarvis-main {
        border-radius: 18px;
      }

      .chat-area {
        padding: 14px 14px 10px;
      }

      .input-area-shell {
        padding: 10px 10px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="jarvis-shell">
    <!-- ===== Sidebar (History) ===== -->
    <aside class="jarvis-sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-header">
          <div class="sidebar-title">
            <div class="sidebar-logo">J</div>
            <div class="sidebar-title-text">
              <span>Jarvis</span>
              <span>Homelab assistant</span>
            </div>
          </div>
          <button class="sidebar-new-chat-btn" id="newChatButton">
            <span class="icon">Ôºã</span>
            <span>New chat</span>
          </button>
        </div>

        <div class="sidebar-section-label">History</div>

        <div class="history-container">
          <div class="history-search">
            <span>üîç</span>
            <input
              type="text"
              id="historySearchInput"
              placeholder="Search conversations..."
            />
          </div>
          <div id="historyList" class="history-list">
            <!-- filled by JS -->
          </div>
          <div id="historyEmptyState" class="history-empty" style="display: none;">
            No history yet. Your chats will appear here once you start talking to Jarvis.
          </div>
        </div>

        <div class="sidebar-footer">
          <span>Jarvis ¬∑ local</span>
          <span id="historyCountLabel">0 chats</span>
        </div>
      </div>
    </aside>

    <!-- ===== Main Panel ===== -->
    <main class="jarvis-main">
      <!-- Header -->
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-header-title">
            Jarvis
            <span class="status-pill">Online</span>
          </div>
          <div class="main-header-subtitle">
            Running in your homelab ¬∑ FastAPI + NGINX ¬∑ /ask + /history
          </div>
        </div>
        <div class="main-header-right">
          <span>Brain activity</span>
          <div class="dot-pulse">
            <span></span><span></span><span></span>
          </div>
        </div>
      </header>

      <!-- Chat area -->
      <section id="chatArea" class="chat-area">
        <div class="chat-empty-placeholder" id="chatEmptyPlaceholder">
          Ask Jarvis anything about your homelab setup, Docker services, logs, or future automations.
          Your conversations will be saved in the sidebar for quick access ‚Äî Gemini style.
        </div>
      </section>

      <!-- Input area -->
      <section class="input-area-shell">
        <form id="askForm" class="input-card">
          <span class="input-prefix">‚Ä∫</span>
          <input
            id="questionInput"
            class="input-field"
            type="text"
            placeholder="Ask Jarvis something‚Ä¶"
            autocomplete="off"
            required
          />
          <button id="sendButton" class="send-button" type="submit">
            <span class="icon">‚û§</span>
            <span>Send</span>
          </button>
        </form>
        <div class="input-footer">
          <span>Jarvis connects to your FastAPI backend at <code>/ask</code> and <code>/history</code>.</span>
          <span id="latencyLabel">Ready.</span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ==============================
    //  Small utilities
    // ==============================

    function formatTimestamp(ts) {
      if (!ts) return "";
      try {
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return "";
        return d.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit"
        });
      } catch {
        return "";
      }
    }

    function truncate(text, max) {
      if (!text) return "";
      if (text.length <= max) return text;
      return text.slice(0, max - 1) + "‚Ä¶";
    }

    // ==============================
    //  Chat rendering
    // ==============================

    const chatArea = document.getElementById("chatArea");
    const chatEmptyPlaceholder = document.getElementById("chatEmptyPlaceholder");

    function ensureChatNotEmpty() {
      if (chatArea && chatArea.children.length > 0) {
        if (chatEmptyPlaceholder) chatEmptyPlaceholder.style.display = "none";
      }
    }

    function appendMessage(role, text) {
      ensureChatNotEmpty();

      const wrapper = document.createElement("div");
      wrapper.classList.add("chat-message");
      if (role === "user") wrapper.classList.add("user");
      else wrapper.classList.add("bot");

      const avatar = document.createElement("div");
      avatar.classList.add("chat-avatar");
      avatar.textContent = role === "user" ? "You" : "J";

      const content = document.createElement("div");
      content.classList.add("chat-content");

      const roleLabel = document.createElement("div");
      roleLabel.classList.add("chat-role");
      roleLabel.textContent = role === "user" ? "You" : "Jarvis";

      const textDiv = document.createElement("div");
      textDiv.classList.add("chat-text");
      textDiv.textContent = text;

      content.appendChild(roleLabel);
      content.appendChild(textDiv);

      wrapper.appendChild(avatar);
      wrapper.appendChild(content);

      chatArea.appendChild(wrapper);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // ==============================
    //  /ask integration
    // ==============================

    const askForm = document.getElementById("askForm");
    const questionInput = document.getElementById("questionInput");
    const sendButton = document.getElementById("sendButton");
    const latencyLabel = document.getElementById("latencyLabel");

    let isSending = false;

    async function handleAsk(event) {
      event.preventDefault();
      if (isSending) return;

      const question = questionInput.value.trim();
      if (!question) return;

      isSending = true;
      sendButton.disabled = true;
      latencyLabel.textContent = "Thinking‚Ä¶";

      const started = performance.now();
      appendMessage("user", question);
      questionInput.value = "";

      try {
        const response = await fetch("/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ question })
        });

        if (!response.ok) {
          throw new Error("Non-200 response from /ask: " + response.status);
        }

        const data = await response.json();
        const answer = data.answer ?? JSON.stringify(data);
        appendMessage("bot", answer);
      } catch (err) {
        console.error(err);
        appendMessage(
          "bot",
          "Sorry, I couldn‚Äôt reach the /ask endpoint.\n\n" +
          "Error: " + (err && err.message ? err.message : String(err))
        );
      } finally {
        isSending = false;
        sendButton.disabled = false;
        const elapsed = performance.now() - started;
        latencyLabel.textContent = "Last response: " + Math.round(elapsed) + " ms";

        // üîÅ After every /ask, refresh the sidebar history
        fetchHistory();
      }
    }

    if (askForm) {
      askForm.addEventListener("submit", handleAsk);
    }

    // ==============================
    //  /history integration (sidebar)
    // ==============================

    const historyListEl = document.getElementById("historyList");
    const historyEmptyStateEl = document.getElementById("historyEmptyState");
    const historyCountLabel = document.getElementById("historyCountLabel");
    const historySearchInput = document.getElementById("historySearchInput");

    let historyItems = [];
    let activeHistoryId = null;

    function renderHistoryList(filterText = "") {
      if (!historyListEl) return;
      historyListEl.innerHTML = "";

      const normalizedFilter = filterText.trim().toLowerCase();

      const filtered = historyItems.filter(item => {
        if (!normalizedFilter) return true;
        return (
          (item.question && item.question.toLowerCase().includes(normalizedFilter)) ||
          (item.answer && item.answer.toLowerCase().includes(normalizedFilter))
        );
      });

      if (historyCountLabel) {
        historyCountLabel.textContent =
          (historyItems.length || 0) + (historyItems.length === 1 ? " chat" : " chats");
      }

      if (filtered.length === 0) {
        if (historyEmptyStateEl) historyEmptyStateEl.style.display = "block";
        return;
      } else {
        if (historyEmptyStateEl) historyEmptyStateEl.style.display = "none";
      }

      filtered.forEach(item => {
        // Adjust property names here if your /history schema is different:
        const id = item.id ?? item.conversation_id ?? item.uuid ?? null;
        const question = item.question ?? item.prompt ?? "";
        const answer = item.answer ?? item.response ?? "";
        const ts = item.timestamp ?? item.created_at ?? item.time ?? null;

        const el = document.createElement("div");
        el.classList.add("history-item");
        if (id && id === activeHistoryId) {
          el.classList.add("active");
        }

        const title = document.createElement("div");
        title.classList.add("history-item-title");
        title.textContent = truncate(question || "Untitled conversation", 60);

        const preview = document.createElement("div");
        preview.classList.add("history-item-preview");
        preview.textContent = truncate(answer, 100);

        const meta = document.createElement("div");
        meta.classList.add("history-item-meta");

        const timeSpan = document.createElement("span");
        timeSpan.textContent = formatTimestamp(ts) || "Recent";

        const dot = document.createElement("span");
        dot.classList.add("history-item-dot");

        meta.appendChild(timeSpan);
        meta.appendChild(dot);

        el.appendChild(title);
        el.appendChild(preview);
        el.appendChild(meta);

        // Optional: clicking a history item can highlight it.
        // (Later we can wire this to re-load the conversation into the main panel.)
        el.addEventListener("click", () => {
          activeHistoryId = id;
          document
            .querySelectorAll(".history-item")
            .forEach(node => node.classList.remove("active"));
          el.classList.add("active");
        });

        historyListEl.appendChild(el);
      });
    }

    async function fetchHistory() {
      try {
        const res = await fetch("/history", {
          method: "GET",
          headers: {
            "Accept": "application/json"
          }
        });

        if (!res.ok) {
          throw new Error("Non-200 response from /history: " + res.status);
        }

        const data = await res.json();

        // Assuming /history returns an array. If it returns {items:[...]} tweak here.
        if (Array.isArray(data)) {
          historyItems = data;
        } else if (Array.isArray(data.items)) {
          historyItems = data.items;
        } else {
          console.warn("Unexpected /history payload shape:", data);
          historyItems = [];
        }

        renderHistoryList(historySearchInput ? historySearchInput.value : "");
      } catch (err) {
        console.error("Failed to load history:", err);
        if (historyEmptyStateEl) {
          historyEmptyStateEl.style.display = "block";
          historyEmptyStateEl.textContent =
            "Could not load history from /history. Check the backend logs.";
        }
      }
    }

    if (historySearchInput) {
      historySearchInput.addEventListener("input", () => {
        renderHistoryList(historySearchInput.value);
      });
    }

    // ==============================
    //  New chat button
    // ==============================

    const newChatButton = document.getElementById("newChatButton");
    if (newChatButton) {
      newChatButton.addEventListener("click", () => {
        // Simple behavior for now:
        // - Clear chat area
        // - Clear active history highlight
        // (The backend can still keep history; this is just a fresh view.)
        chatArea.innerHTML = "";
        if (chatEmptyPlaceholder) chatEmptyPlaceholder.style.display = "block";
        activeHistoryId = null;
        document
          .querySelectorAll(".history-item")
          .forEach(node => node.classList.remove("active"));
      });
    }

    // ==============================
    //  Initial load
    // ==============================

    window.addEventListener("DOMContentLoaded", () => {
      // Load history immediately on page load ‚úÖ
      fetchHistory();

      // Optional: auto-focus input
      if (questionInput) {
        questionInput.focus();
      }
    });
  </script>
</body>
</html>
